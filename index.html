<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Email Runner</title>
<style>
  :root{
    --bg1:#fff1f8; --bg2:#e9fbff;
    --ink:#1f2a37; --muted:#5b6b7a;
    --purple:#6c63ff; --blue:#00c2ff; --green:#22c55e; --orange:#f59e0b; --red:#ef4444;
    --card:#ffffffcc; --stroke: rgba(31,42,55,.12); --stroke2: rgba(108,99,255,.18);
    --shadow: 0 16px 40px rgba(0,0,0,.14); --radius: 22px;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family: ui-rounded, "Comic Sans MS", "Trebuchet MS", system-ui, -apple-system, Segoe UI, Arial;
    color:var(--ink);
    background:
      radial-gradient(1100px 800px at 15% 10%, var(--bg1), transparent 62%),
      radial-gradient(1100px 800px at 85% 35%, var(--bg2), transparent 62%),
      linear-gradient(180deg, #ffffff, #f7fbff);
    padding: 12px;
  }
  .wrap{ max-width: 1300px; margin:0 auto; height: calc(100vh - 24px); display:flex; flex-direction:column; gap:10px; }

  /* Top HUD */
  .hud{
    background: var(--card);
    border:2px solid var(--stroke2);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 10px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .brand{ display:flex; align-items:center; gap:10px; }
  .logo{
    width:48px; height:48px; border-radius:18px;
    display:grid; place-items:center;
    background: linear-gradient(135deg, rgba(108,99,255,.18), rgba(0,194,255,.18));
    border:2px solid rgba(108,99,255,.18);
    box-shadow: 0 10px 22px rgba(0,0,0,.12);
    font-size: 28px;
  }
  h1{ margin:0; font-size:18px; }
  .sub{ margin:0; font-size:12px; font-weight:900; color:var(--muted); }

  .pills{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
  .pill{
    background: rgba(255,255,255,.9);
    border:2px solid var(--stroke);
    border-radius:999px;
    padding: 8px 10px;
    font-weight:1000;
    box-shadow: 0 10px 18px rgba(0,0,0,.10);
    user-select:none;
    display:flex; align-items:center; gap:8px;
  }
  .nameBox{
    background: rgba(255,255,255,.9);
    border:2px solid var(--stroke);
    border-radius:999px;
    padding: 8px 10px;
    box-shadow: 0 10px 18px rgba(0,0,0,.10);
    display:flex; align-items:center; gap:8px;
    font-weight:1000;
  }
  .nameBox label{ font-size:12px; font-weight:1000; color:var(--muted); }
  .nameBox input{
    border:0; outline:none; background:transparent;
    width:160px; font-weight:1000;
  }
  .btn{
    border:0;
    border-radius:999px;
    padding: 10px 12px;
    cursor:pointer;
    font-weight:1100;
    box-shadow: 0 12px 22px rgba(0,0,0,.12);
    background:#fff;
    border:2px solid rgba(108,99,255,.16);
    display:flex; align-items:center; gap:8px;
    user-select:none;
  }
  .btn:active{ transform: translateY(1px) scale(.99); }
  .btnPrimary{ background: linear-gradient(135deg, var(--purple), var(--blue)); border:0; color:#fff; }

  /* 75/25 layout */
  .layout{
    flex:1;
    display:flex;
    gap:10px;
    min-height:0; /* allow children scroll if needed */
  }
  .left{
    flex: 3; /* 75% */
    min-width: 0;
    background: var(--card);
    border:2px solid var(--stroke2);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 10px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .right{
    flex: 1; /* 25% */
    min-width: 260px;
    background: var(--card);
    border:2px solid var(--stroke2);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 10px;
    display:flex;
    flex-direction:column;
    gap:10px;
    overflow:auto;
  }
  @media (max-width: 980px){
    .layout{ flex-direction:column; }
    .right{ min-width: 0; }
  }

  .sectionTitle{
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
  }
  .sectionTitle h2{ margin:0; font-size:14px; }
  .help{ margin:0; font-size:12px; font-weight:900; color:var(--muted); }

  .gameWrap{
    flex:1;
    min-height: 0;
    border-radius: 18px;
    border:2px solid rgba(31,42,55,.12);
    background: rgba(255,255,255,.9);
    overflow:hidden;
    position: relative;
  }
  canvas{ width:100%; height:100%; display:block; }

  /* Little pause hint (optional but helpful) */
  .pauseBadge{
    position:absolute;
    left: 12px;
    top: 12px;
    padding: 8px 10px;
    border-radius: 999px;
    background: rgba(255,255,255,.92);
    border: 2px solid rgba(31,42,55,.12);
    box-shadow: 0 10px 18px rgba(0,0,0,.10);
    font-weight: 1100;
    display:none;
    z-index: 5;
  }

  .card{
    background: rgba(255,255,255,.92);
    border:2px solid rgba(31,42,55,.12);
    border-radius: 18px;
    padding: 10px;
  }
  .cardTitle{
    font-weight:1100;
    display:flex; justify-content:space-between; align-items:center; gap:8px;
    margin-bottom: 8px;
  }
  .mini{ font-size:12px; font-weight:900; color:var(--muted); }

  .slot{
    padding: 10px 12px;
    border-radius: 14px;
    border:2px dashed rgba(31,42,55,.20);
    background:#fff;
    font-weight:1000;
    margin-bottom: 8px;
  }
  .slot.empty{ color: rgba(31,42,55,.45); }
  .preview{
    white-space: pre-wrap;
    line-height: 1.5;
    font-weight:1000;
    background:#fff;
    border:2px solid rgba(31,42,55,.10);
    border-radius:14px;
    padding:10px;
    min-height: 140px;
  }

  /* Popup */
  .overlay{
    position:fixed; inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    padding: 16px;
    background: rgba(15,23,42,.55);
    z-index: 50;
  }
  .modal{
    width: min(780px, 100%);
    background:#fff;
    border-radius: 24px;
    border:2px solid rgba(108,99,255,.20);
    box-shadow: var(--shadow);
    padding: 14px;
  }


.certModal{
  width: min(980px, 100%);
  max-height: 92vh;
  overflow: hidden;
  display:flex;
  flex-direction:column;
}
.certPreview{
  flex:1;
  overflow:auto;
  padding: 10px;
  border-radius: 18px;
  border:2px solid rgba(31,42,55,.10);
  background: rgba(255,255,255,.9);
}
#certImg{
  width: 100%;
  height: auto;
  display:block;
  border-radius: 18px;
  box-shadow: 0 16px 40px rgba(0,0,0,.14);
}
.certActions{
  position: sticky;
  bottom: 0;
  background: #fff;
  padding-top: 10px;
}

  .modalTop{
    display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
    margin-bottom: 8px;
  }
  .bigStars{ font-size: 44px; text-align:center; margin: 6px 0 10px; }
  .modalBody{
    font-weight:1000;
    color: var(--muted);
    line-height: 1.55;
  }
  .actions{
    margin-top: 12px;
    display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;
  }
  .btnSoft{ background: rgba(34,197,94,.14); border:2px solid rgba(34,197,94,.26); }
  .btnWarn{ background: rgba(245,158,11,.14); border:2px solid rgba(245,158,11,.26); }

  .toast{
    position:fixed;
    left:50%;
    bottom: 14px;
    transform: translateX(-50%);
    background: rgba(255,255,255,.96);
    border: 2px solid rgba(31,42,55,.12);
    border-radius: 999px;
    padding: 10px 14px;
    box-shadow: var(--shadow);
    display:none;
    font-weight: 1100;
    z-index: 60;
    max-width: min(900px, calc(100vw - 24px));
  }
</style>
</head>
<body>
<div class="wrap">

  <div class="hud">
    <div class="brand">
      <div class="logo">üèÉ‚Äç‚ôÇÔ∏è</div>
      <div>
        <h1>Email Runner</h1>
        <p class="sub">Collect 4 pieces ‚Üí auto-check ‚Üí next level</p>
      </div>
    </div>

    <div class="pills">
      <div class="pill">üß© Level: <span id="levelUI">1</span></div>
      <div class="pill">‚ù§Ô∏è <span id="heartsUI">‚ô•‚ô•‚ô•</span></div>
      <div class="pill">‚≠ê <span id="starsUI">‚òÜ‚òÜ‚òÜ</span></div>
      <div class="pill">ü™ô <span id="coinsUI">0</span></div>

      <div class="nameBox">
        <label for="studentName">Student</label>
        <input id="studentName" type="text" placeholder="Type your name" maxlength="20" />
      </div>

      <button class="btn btnWarn" id="resetBtn">üîÅ Reset</button>
      <button class="btn" id="howBtn">üìò How</button>
    </div>
  </div>

  <div class="layout">
    <!-- 75% GAME -->
    <div class="left">
      <div class="sectionTitle">
        <h2>üéÆ Game Area</h2>
        <p class="help">Move: Arrow keys / WASD ‚Ä¢ Avoid üëæ ‚Ä¢ Collect ü™ô + bubbles</p>
      </div>
      <div class="gameWrap">
        <div class="pauseBadge" id="pauseBadge">‚è∏ Paused (popup open)</div>
        <canvas id="game"></canvas>
      </div>
      <p class="help" id="goalText">Goal: Collect Subject, Greeting, Sentence, Closing.</p>
    </div>

    <!-- 25% MESSAGES -->
    <div class="right">
      <div class="card">
        <div class="cardTitle">‚úÖ Your Email Pieces <span class="mini" id="countUI">0/4</span></div>
        <div class="slot" id="slotSubject">Subject: (none)</div>
        <div class="slot" id="slotGreeting">Greeting: (none)</div>
        <div class="slot" id="slotSentence">Sentence: (none)</div>
        <div class="slot" id="slotClosing">Closing: (none)</div>
      </div>

      <div class="card">
        <div class="cardTitle">üì® Preview <span class="mini">auto-check when complete</span></div>
        <div class="preview" id="preview">Collect pieces to build your email!</div>
        <div class="mini" style="margin-top:8px;">
          Safe rule: no password, phone number, or home address.
        </div>
      </div>

      <div class="card">
        <div class="cardTitle">üõí Mini Shop <span class="mini">easy mode</span></div>
        <div class="mini">Buy with coins ü™ô (optional):</div>
        <div style="display:grid; gap:8px; margin-top:8px;">
          <button class="btn" id="buyShield">üõ°Ô∏è Shield (free start) +10s ‚Äî 8ü™ô</button>
          <button class="btn" id="buySpeed">‚ö° Speed +20s ‚Äî 8ü™ô</button>
        </div>
      </div>

    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<!-- How modal -->
<div class="overlay" id="howOverlay">
  <div class="modal">
    <div class="modalTop">
      <strong>üìò How to Play</strong>
      <button class="btn" id="closeHow">‚úñ Close</button>
    </div>
    <div class="modalBody">
      <ul style="margin:0; padding-left:18px;">
        <li>Move with <b>Arrow Keys</b> or <b>WASD</b>.</li>
        <li>Collect 4 blue bubbles: <b>Subject, Greeting, Sentence, Closing</b>.</li>
        <li>Avoid red bubbles (unsafe / rude) and avoid enemies üëæ.</li>
        <li>When you collect all 4 pieces, the game will <b>auto-check</b> and show stars ‚≠ê.</li>
        <li>Tap <b>Next Level</b> in the popup.</li>
      </ul>
    </div>
    <div class="actions">
      <button class="btn btnPrimary" id="okHow">‚úÖ Got it</button>
    </div>
  </div>
</div>

<!-- Result modal -->
<div class="overlay" id="resultOverlay">
  <div class="modal">
    <div class="modalTop">
      <strong id="resultTitle">Result</strong>
      <button class="btn" id="closeResult">‚úñ</button>
    </div>
    <div class="bigStars" id="resultStars">‚≠ê</div>
    <div class="modalBody" id="resultBody"></div>
    <div class="actions">
      <button class="btn btnWarn" id="retryBtn">üîÅ Retry</button>
      <button class="btn btnPrimary" id="nextLevelBtn">‚û°Ô∏è Next Level</button>
    </div>
  </div>
</div>


<div class="overlay" id="certOverlay">
  <div class="modal certModal">
    <div class="modalTop">
      <strong>üéì Certificate of Completion</strong>
      <button class="btn" id="closeCert">‚úñ</button>
    </div>

    <div class="certPreview">
      <img id="certImg" alt="Certificate preview" />
      <div class="mini" style="margin-top:10px;">
        ‚úÖ Click save to download certificate.
      </div>
    </div>

    <div class="actions certActions">
      <button class="btn btnSoft" id="savePngCert">üíæ Save</button>
      <button class="btn btnPrimary" id="restartGame">üîÅ Play Again</button>
    </div>
  </div>
</div>

<script>
    
(() => {
  const $ = (id)=>document.getElementById(id);
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const rnd = (a,b)=>a+Math.random()*(b-a);

  const MAX_LEVEL = 20;

  function showToast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>t.style.display="none", 1200);
  }

  function beep(freq=700, ms=60){
    try{
      const ctx = beep._ctx || (beep._ctx = new (window.AudioContext||window.webkitAudioContext)());
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type="sine"; o.frequency.value=freq;
      g.gain.value=0.03;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      setTimeout(()=>o.stop(), ms);
    }catch{}
  }

  // LEVEL DATA (each level different, but still simple for Grade 1)
  const LEVELS = [
    {
      name:"Say Hello",
      goal:"Collect: Subject + Greeting + Sentence + Closing",
      subject:["Hello Teacher","Hello!"],
      greeting:["Hello Teacher,","Hi Teacher,"],
      sentence:["My name is ____.","I am in Grade 1."],
      closing:["Thank you.","From, ____"],
    },
    {
      name:"What I Learned",
      goal:"Tell one thing you learned",
      subject:["Today I learned","My ICT learning"],
      greeting:["Dear Teacher,","Hello Teacher,"],
      sentence:["Today I learned how to type.","Today I learned how to save."],
      closing:["Thank you.","Have a nice day!"],
    },
    {
      name:"Kind Question",
      goal:"Ask politely",
      subject:["A question","Question for you"],
      greeting:["Hello Teacher,","Dear Teacher,"],
      sentence:["Can you help me, please?","How do I open my file?"],
      closing:["Thank you.","From, ____"],
    },
    {
      name:"Kind Message",
      goal:"Say something nice",
      subject:["Kind message","Hello friend"],
      greeting:["Hello,","Hi there,"],
      sentence:["Great job today!","I like your drawing."],
      closing:["From, ____","Thank you."],
    }
  ];

  const BAD_PIECES = [
    {type:"Sentence", text:"My password is 1234."},
    {type:"Sentence", text:"Call me at 09____."},
    {type:"Sentence", text:"My home is at ____ street."},
    {type:"Subject", text:"FREE MONEY!!!"},
    {type:"Greeting", text:"HEY!!!"},
    {type:"Closing", text:"DO IT NOW!"},
  ];

  // ===== INPUT + PAUSE HELPERS =====
  const keys = new Set();

  function isTypingTarget(el){
    if(!el) return false;
    const tag = (el.tagName || "").toLowerCase();
    return tag === "input" || tag === "textarea" || el.isContentEditable;
  }

  function anyPopupOpen(){
    const ids = ["howOverlay", "resultOverlay", "certOverlay"];
    return ids.some(id => {
      const el = $(id);
      return el && el.style.display === "flex";
    });
  }

  function clearMovementKeys(){ keys.clear(); }

  // STATE
  const state = {
    level: 1,
    hearts: 3,
    stars: 0,
    coins: 0,
    // easy-mode powers
    shield: 10,        // free at start
    speed: 0,
    hurtCD: 0,         // longer invincibility
    collected: { Subject:null, Greeting:null, Sentence:null, Closing:null },
    checking: false,   // prevents multiple popups
    paused: false
  };

  function setPaused(on){
    state.paused = !!on;
    if(state.paused) clearMovementKeys();
    $("pauseBadge").style.display = state.paused ? "block" : "none";
  }

  function refreshPause(){ setPaused(anyPopupOpen()); }

  // Keyboard listeners (FIX: allow typing WASD in inputs)
  window.addEventListener("keydown",(e)=>{
    if(isTypingTarget(document.activeElement)) return;

    const k = e.key.toLowerCase();
    if(["arrowup","arrowdown","arrowleft","arrowright","w","a","s","d"].includes(k)){
      keys.add(k);
      e.preventDefault();
    }
  }, {passive:false});

  window.addEventListener("keyup",(e)=>{
    if(isTypingTarget(document.activeElement)) return;
    keys.delete(e.key.toLowerCase());
  });

  function currentLevel(){ return LEVELS[(state.level-1) % LEVELS.length]; }

  function setHearts(n){
    state.hearts = clamp(n,0,3);
    $("heartsUI").textContent = "‚ô•".repeat(state.hearts) + "‚ô°".repeat(3-state.hearts);
  }
  function setStars(n){
    state.stars = clamp(n,0,3);
    $("starsUI").textContent = "‚òÖ".repeat(state.stars) + "‚òÜ".repeat(3-state.stars);
  }
  function setCoins(n){
    state.coins = Math.max(0, Math.floor(n));
    $("coinsUI").textContent = state.coins;
  }

  function resetCollected(){
    state.collected.Subject = null;
    state.collected.Greeting = null;
    state.collected.Sentence = null;
    state.collected.Closing = null;
    state.checking = false;
    updateRightPanel();
  }

  function updateRightPanel(){
    const slot = (id, label, val)=>{
      const el = $(id);
      el.textContent = `${label}: ${val || "(none)"}`;
      el.classList.toggle("empty", !val);
    };

    slot("slotSubject","Subject",state.collected.Subject);
    slot("slotGreeting","Greeting",state.collected.Greeting);
    slot("slotSentence","Sentence",state.collected.Sentence);
    slot("slotClosing","Closing",state.collected.Closing);

    const have = ["Subject","Greeting","Sentence","Closing"].filter(k=>!!state.collected[k]).length;
    $("countUI").textContent = `${have}/4`;

    const name = ($("studentName").value || "").trim();
    const rep = (t)=> (t||"").replaceAll("____", name || "____");

    const preview =
`To: Teacher
Subject: ${rep(state.collected.Subject||"")}

${rep(state.collected.Greeting||"")}
${rep(state.collected.Sentence||"")}
${rep(state.collected.Closing||"")}`.trim();

    $("preview").textContent = have ? preview : "Collect pieces to build your email!";

    // AUTO CHECK when complete
    if(have === 4 && !state.checking){
      state.checking = true;
      setTimeout(()=>autoCheckAndPopup(), 350);
    }
  }

  function isUnsafeText(text){
    const t = (text||"").toLowerCase();
    const bad = ["password","phone","call me","address","street","credit card","free money"];
    return bad.some(w => t.includes(w));
  }

  function autoCheckAndPopup(){
    const L = currentLevel();
    const combined = [state.collected.Subject, state.collected.Greeting, state.collected.Sentence, state.collected.Closing].join(" ");

    let stars = 2; // base
    if(isUnsafeText(combined)) stars = 1;

    const perfect =
      L.subject.includes(state.collected.Subject) &&
      L.greeting.includes(state.collected.Greeting) &&
      L.sentence.includes(state.collected.Sentence) &&
      L.closing.includes(state.collected.Closing);

    if(perfect && !isUnsafeText(combined)) stars = 3;

    // small penalty if they got hit a lot
    if(state.hearts <= 1 && stars > 1) stars -= 1;

    setStars(stars);

    $("resultTitle").textContent = stars === 3 ? "Perfect! üéâ" : (stars === 2 ? "Nice! ‚≠ê‚≠ê" : "Try Again üôÇ");
    $("resultStars").textContent = "‚≠ê".repeat(stars);

    const name = ($("studentName").value || "").trim();
    const rep = (t)=> (t||"").replaceAll("____", name || "____");
    const preview =
`To: Teacher
Subject: ${rep(state.collected.Subject)}

${rep(state.collected.Greeting)}
${rep(state.collected.Sentence)}
${rep(state.collected.Closing)}`;

    const reward = stars === 3 ? 8 : (stars === 2 ? 5 : 2);
    setCoins(state.coins + reward);

    $("resultBody").innerHTML = `
      <div style="white-space:pre-wrap; background:#fff; border:2px solid rgba(31,42,55,.10); border-radius:14px; padding:10px; margin-top:8px;">${preview}</div>
      <div style="margin-top:10px;">
        ü™ô Reward: <b>+${reward}</b> coins
        <br/>Tip: Collect the best pieces for this level to get ‚≠ê‚≠ê‚≠ê
      </div>
    `;

    // Next button label becomes certificate at level 20
    $("nextLevelBtn").textContent = (state.level >= MAX_LEVEL) ? "üéì Get Certificate" : "‚û°Ô∏è Next Level";

    $("resultOverlay").style.display = "flex";
    refreshPause();

    beep(960,80);
    setTimeout(()=>beep(1120,80), 90);
  }

 function showCertificate(){
  const student = ($("studentName").value || "").trim() || "____________";
  const teacher = "Jaspel Bosales";
  const d = new Date();
  const dateStr = d.toLocaleDateString(undefined, { year:"numeric", month:"long", day:"numeric" });

  // Create A4 PNG and show preview
  const dataUrl = makeCertificatePNG({
    student,
    teacher,
    dateStr,
    levels: MAX_LEVEL
  });

  $("certImg").src = dataUrl;

  $("certOverlay").style.display = "flex";
  refreshPause();

  beep(960,80);
  setTimeout(()=>beep(1120,80), 90);
}

/* ‚úÖ A4 PNG generator (Canvas) */
function makeCertificatePNG({ student, teacher, dateStr, levels }){
  // A4 @ 300dpi (great for printing)
  const W = 2480, H = 3508;

  const c = document.createElement("canvas");
  c.width = W; c.height = H;
  const g = c.getContext("2d");

  // Helpers
  const rrect = (x,y,w,h,r)=>{
    r = Math.min(r, w/2, h/2);
    g.beginPath();
    g.moveTo(x+r,y);
    g.arcTo(x+w,y,x+w,y+h,r);
    g.arcTo(x+w,y+h,x,y+h,r);
    g.arcTo(x,y+h,x,y,r);
    g.arcTo(x,y,x+w,y,r);
    g.closePath();
  };
  const shadow = (blur, alpha)=>{
    g.shadowColor = `rgba(0,0,0,${alpha})`;
    g.shadowBlur = blur;
    g.shadowOffsetX = 0;
    g.shadowOffsetY = Math.round(blur*0.6);
  };
  const noShadow = ()=>{ g.shadowColor="transparent"; g.shadowBlur=0; g.shadowOffsetX=0; g.shadowOffsetY=0; };

  // Background
  g.fillStyle = "#ffffff";
  g.fillRect(0,0,W,H);

  // Soft gradients
  const grad1 = g.createRadialGradient(W*0.2,H*0.18,10, W*0.2,H*0.18, W*0.9);
  grad1.addColorStop(0,"rgba(255,241,248,0.95)");
  grad1.addColorStop(1,"rgba(255,241,248,0)");
  g.fillStyle = grad1; g.fillRect(0,0,W,H);

  const grad2 = g.createRadialGradient(W*0.82,H*0.28,10, W*0.82,H*0.28, W*0.9);
  grad2.addColorStop(0,"rgba(233,251,255,0.95)");
  grad2.addColorStop(1,"rgba(233,251,255,0)");
  g.fillStyle = grad2; g.fillRect(0,0,W,H);

  // Confetti dots
  const dots = [
    ["rgba(108,99,255,.55)", 0.10, 0.12],
    ["rgba(0,194,255,.55)",  0.28, 0.08],
    ["rgba(245,158,11,.55)", 0.62, 0.11],
    ["rgba(34,197,94,.55)",  0.86, 0.15],
    ["rgba(245,158,11,.45)", 0.14, 0.76],
    ["rgba(108,99,255,.45)", 0.82, 0.86]
  ];
  for(let i=0;i<140;i++){
    const pick = dots[i % dots.length];
    g.fillStyle = pick[0];
    const x = (Math.random()*W);
    const y = (Math.random()*H);
    const r = 6 + Math.random()*8;
    g.beginPath(); g.arc(x,y,r,0,Math.PI*2); g.fill();
  }

  // Outer border
  noShadow();
  g.lineWidth = 18;
  g.strokeStyle = "rgba(108,99,255,.30)";
  rrect(70,70,W-140,H-140,60);
  g.stroke();

  // Header card
  shadow(22,0.14);
  g.fillStyle = "rgba(255,255,255,0.92)";
  g.strokeStyle = "rgba(31,42,55,.10)";
  g.lineWidth = 10;
  rrect(160,160,W-320,240,60);
  g.fill(); g.stroke();
  noShadow();

  // Logo box
  shadow(16,0.12);
  const logoX=210, logoY=200, logoS=150;
  const lg = g.createLinearGradient(logoX,logoY,logoX+logoS,logoY+logoS);
  lg.addColorStop(0,"rgba(108,99,255,.18)");
  lg.addColorStop(1,"rgba(0,194,255,.18)");
  g.fillStyle=lg;
  g.strokeStyle="rgba(108,99,255,.22)";
  g.lineWidth=10;
  rrect(logoX,logoY,logoS,logoS,50);
  g.fill(); g.stroke();
  noShadow();

  // Emoji runner
  g.font = "120px ui-rounded, system-ui, Arial";
  g.fillStyle = "rgba(31,42,55,.90)";
  g.fillText("üèÉ‚Äç‚ôÇÔ∏è", logoX+30, logoY+118);

  // Title
  g.font = "900 88px ui-rounded, system-ui, Arial";
  g.fillText("Email Runner", 400, 270);

  g.font = "900 44px ui-rounded, system-ui, Arial";
  g.fillStyle = "rgba(31,42,55,.65)";
  g.fillText("Certificate of Completion", 400, 330);

  // Right stars
  g.textAlign="right";
  g.font = "900 52px ui-rounded, system-ui, Arial";
  g.fillStyle = "rgba(31,42,55,.65)";
  g.fillText("‚≠ê ‚≠ê ‚≠ê", W-210, 260);
  g.font = "900 36px ui-rounded, system-ui, Arial";
  g.fillText(`Levels 1‚Äì${levels}`, W-210, 315);
  g.textAlign="left";

  // Main text
  g.fillStyle = "rgba(31,42,55,.72)";
  g.font = "900 60px ui-rounded, system-ui, Arial";
  g.textAlign="center";
  g.fillText("This certificate is proudly presented to", W/2, 620);

  // Name badge
  shadow(18,0.10);
  g.fillStyle = "rgba(255,255,255,0.94)";
  g.strokeStyle = "rgba(108,99,255,.35)";
  g.setLineDash([22,18]);
  g.lineWidth = 10;
  rrect(340, 720, W-680, 190, 60);
  g.fill(); g.stroke();
  g.setLineDash([]);
  noShadow();

  g.fillStyle = "rgba(31,42,55,.92)";
  g.font = "900 140px ui-rounded, system-ui, Arial";
  g.fillText(student, W/2, 855);

  // Completion line
  g.fillStyle = "rgba(31,42,55,.75)";
  g.font = "900 56px ui-rounded, system-ui, Arial";
  g.fillText(`for successfully completing all ${levels} levels of Email Runner.`, W/2, 1020);

  // Skills line
  g.fillStyle = "rgba(31,42,55,.65)";
  g.font = "900 46px ui-rounded, system-ui, Arial";
  g.fillText("You learned: Subject ‚Ä¢ Greeting ‚Ä¢ Sentence ‚Ä¢ Closing", W/2, 1120);
  g.fillText("Keep being kind online! üåà", W/2, 1185);

  // Big badge circle
  shadow(26,0.14);
  const cx=W/2, cy=1600, cr=300;
  const bg3 = g.createLinearGradient(cx-cr,cy-cr,cx+cr,cy+cr);
  bg3.addColorStop(0,"rgba(108,99,255,.18)");
  bg3.addColorStop(1,"rgba(0,194,255,.18)");
  g.fillStyle = bg3;
  g.strokeStyle = "rgba(108,99,255,.28)";
  g.lineWidth = 14;
  g.beginPath(); g.arc(cx,cy,cr,0,Math.PI*2); g.fill(); g.stroke();
  noShadow();

  g.font = "260px ui-rounded, system-ui, Arial";
  g.fillStyle = "rgba(31,42,55,.90)";
  g.fillText("üèÖ", cx, cy+90);

  // Bottom cards (Date / Teacher)
  const cardW = (W-160*2-40)/2;
  const cardH = 210;
  const by = H-420;

  shadow(18,0.10);
  g.fillStyle = "rgba(255,255,255,0.92)";
  g.strokeStyle = "rgba(31,42,55,.10)";
  g.lineWidth = 10;

  // Date card
  rrect(160, by, cardW, cardH, 60);
  g.fill(); g.stroke();

  // Teacher card
  rrect(160+cardW+40, by, cardW, cardH, 60);
  g.fill(); g.stroke();
  noShadow();

  // Date text
  g.textAlign="left";
  g.fillStyle="rgba(31,42,55,.70)";
  g.font="900 36px ui-rounded, system-ui, Arial";
  g.fillText("Date", 220, by+70);
  g.font="900 54px ui-rounded, system-ui, Arial";
  g.fillStyle="rgba(31,42,55,.85)";
  g.fillText(dateStr, 220, by+145);

  // Teacher text
  g.textAlign="right";
  g.fillStyle="rgba(31,42,55,.70)";
  g.font="900 36px ui-rounded, system-ui, Arial";
  g.fillText("Teacher", W-220, by+70);
  g.font="900 54px ui-rounded, system-ui, Arial";
  g.fillStyle="rgba(31,42,55,.85)";
  g.fillText(teacher, W-220, by+145);

  g.textAlign="left";

  return c.toDataURL("image/png");
}

/* ‚úÖ Download the PNG */
function downloadCertPNG(){
  const student = ($("studentName").value || "").trim() || "Student";
  const teacher = "Jaspel Bosales";
  const d = new Date();
  const dateStr = d.toLocaleDateString(undefined, { year:"numeric", month:"long", day:"numeric" });

  const dataUrl = makeCertificatePNG({
    student,
    teacher,
    dateStr,
    levels: MAX_LEVEL
  });

  const a = document.createElement("a");
  const safeName = student.replace(/[^a-z0-9\-_ ]/gi,"").trim().replace(/\s+/g,"-") || "Student";
  a.href = dataUrl;
  a.download = `EmailRunner-Certificate-${safeName}.png`;
  document.body.appendChild(a);
  a.click();
  a.remove();
}



  function goNextLevel(){
    // stop at max level and award certificate
    if(state.level >= MAX_LEVEL){
      $("resultOverlay").style.display = "none";
      refreshPause();
      showCertificate();
      return;
    }

    state.level++;
    $("levelUI").textContent = state.level;
    const L = currentLevel();
    $("goalText").textContent = `Goal: ${L.name} ‚Äî ${L.goal}`;

    // easy start each level
    state.shield = 10;
    state.speed = 0;
    state.hurtCD = 0;
    setHearts(3);
    resetCollected();
    spawnAll();

    $("resultOverlay").style.display = "none";
    refreshPause();
    showToast("‚û°Ô∏è Next Level!");
  }

  function retryLevel(){
    state.shield = 10;
    state.speed = 0;
    state.hurtCD = 0;
    setHearts(3);
    resetCollected();
    spawnAll();

    $("resultOverlay").style.display = "none";
    refreshPause();
    showToast("üîÅ Try again!");
  }

  // SHOP (simple)
  $("buyShield").addEventListener("click", ()=>{
    if(state.coins < 8) return showToast("Need more coins ü™ô");
    setCoins(state.coins - 8);
    state.shield += 10;
    showToast("üõ°Ô∏è Shield +10s!");
    beep(880,70);
  });
  $("buySpeed").addEventListener("click", ()=>{
    if(state.coins < 8) return showToast("Need more coins ü™ô");
    setCoins(state.coins - 8);
    state.speed += 20;
    showToast("‚ö° Speed +20s!");
    beep(880,70);
  });

  // ===== Canvas / Game =====
  const canvas = $("game");
  const ctx = canvas.getContext("2d");

  // World in ‚Äúworld units‚Äù
  const world = { w: 1100, h: 680, blocks: [] };

  function resizeCanvas(){
    const rect = canvas.getBoundingClientRect();
    const cssW = Math.max(300, rect.width);
    const cssH = Math.max(220, rect.height);
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    canvas.width = Math.round(cssW * dpr);
    canvas.height = Math.round(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }

  function makeBlocks(){
    // fewer blocks = easier navigation
    world.blocks = [
      {x: 230, y: 150, w: 150, h: 50},
      {x: 700, y: 170, w: 160, h: 50},
      {x: 440, y: 420, w: 210, h: 55},
    ];
  }

  const player = { x: 120, y: 120, r: 20, speed: 280, face:"üôÇ" };
  let bubbles = [];
  let coins = [];
  let enemies = [];

  // SAFE ZONE (enemies avoid center)
  const safeZone = { x: world.w/2 - 160, y: world.h/2 - 120, w: 320, h: 240 };

  function rectHitCircle(rect, cx, cy, r){
    const closestX = clamp(cx, rect.x, rect.x + rect.w);
    const closestY = clamp(cy, rect.y, rect.y + rect.h);
    const dx = cx - closestX, dy = cy - closestY;
    return (dx*dx + dy*dy) <= r*r;
  }
  function pushOut(rect, obj){
    const cx=obj.x, cy=obj.y, r=obj.r;
    const left = Math.abs((rect.x) - (cx + r));
    const right = Math.abs((rect.x + rect.w) - (cx - r));
    const top = Math.abs((rect.y) - (cy + r));
    const bottom = Math.abs((rect.y + rect.h) - (cy - r));
    const min = Math.min(left,right,top,bottom);
    if(min === left) obj.x = rect.x - r;
    else if(min === right) obj.x = rect.x + rect.w + r;
    else if(min === top) obj.y = rect.y - r;
    else obj.y = rect.y + rect.h + r;
  }

  function keepOutOfBlocks(obj){
    for(const b of world.blocks){
      if(rectHitCircle(b, obj.x, obj.y, obj.r || 16)){
        obj.x = rnd(60, world.w-60);
        obj.y = rnd(60, world.h-60);
      }
    }
  }
  function inside(rect, x, y){
    return x>=rect.x && x<=rect.x+rect.w && y>=rect.y && y<=rect.y+rect.h;
  }

  function makeBubble(type, text, good=true){
    return { type, text, good, x:rnd(70, world.w-70), y:rnd(70, world.h-70), r: good?26:28, bob:rnd(0,Math.PI*2) };
  }
  function makeCoin(){
    return { x:rnd(60, world.w-60), y:rnd(60, world.h-60), r: 12, bob:rnd(0,Math.PI*2) };
  }
  function makeEnemy(){
    return {
      x:rnd(80, world.w-80),
      y:rnd(80, world.h-80),
      r: 18,
      // EASY MODE speeds:
      speed: 95 + state.level*6,
      pauseT: rnd(0.5, 1.6), // pauses often
      face: "üëæ"
    };
  }

  function spawnAll(){
    spawnBubbles();
    spawnCoins();
    spawnEnemies();
  }

  function spawnBubbles(){
    const L = currentLevel();
    bubbles = [
      makeBubble("Subject",  L.subject[Math.floor(Math.random()*L.subject.length)], true),
      makeBubble("Greeting", L.greeting[Math.floor(Math.random()*L.greeting.length)], true),
      makeBubble("Sentence", L.sentence[Math.floor(Math.random()*L.sentence.length)], true),
      makeBubble("Closing",  L.closing[Math.floor(Math.random()*L.closing.length)], true),
    ];

    // fewer bad bubbles (easier)
    const badPick = BAD_PIECES.slice().sort(()=>Math.random()-0.5).slice(0,2);
    bubbles.push(...badPick.map(p=>makeBubble(p.type, p.text, false)));

    // keep out of safe zone a bit (so they still explore)
    for(const b of bubbles){
      keepOutOfBlocks(b);
      if(inside(safeZone, b.x, b.y)){ b.x += 220; b.y += 120; }
    }
  }

  function spawnCoins(){
    coins = [];
    const count = 18; // more coins = easier shop
    for(let i=0;i<count;i++){
      const c = makeCoin();
      keepOutOfBlocks(c);
      coins.push(c);
    }
  }

  function spawnEnemies(){
    enemies = [];
    const count = clamp(1 + Math.floor(state.level/2), 1, 3); // max 3
    for(let i=0;i<count;i++){
      const e = makeEnemy();
      // enemies spawn away from safe zone
      do{
        e.x = rnd(80, world.w-80);
        e.y = rnd(80, world.h-80);
      }while(inside(safeZone, e.x, e.y));
      keepOutOfBlocks(e);
      enemies.push(e);
    }
  }

  function collectBubble(b){
    if(!b.good){
      // mild penalty
      setHearts(state.hearts - 1);
      beep(200,120);
      showToast("üö´ Bad bubble! Try blue ones.");
      return;
    }
    if(state.collected[b.type]) return;

    state.collected[b.type] = b.text;
    updateRightPanel();
    beep(900,60);
    showToast(`‚úÖ Got ${b.type}!`);
  }

  function collectCoin(){
    setCoins(state.coins + 1);
    beep(980,35);
  }

  // Game updates
  let last = performance.now();

  function update(dt){
    // timers
    state.shield = Math.max(0, state.shield - dt);
    state.speed  = Math.max(0, state.speed  - dt);
    state.hurtCD = Math.max(0, state.hurtCD - dt);

    // movement
    let ax=0, ay=0;
    if(keys.has("arrowleft")||keys.has("a")) ax -= 1;
    if(keys.has("arrowright")||keys.has("d")) ax += 1;
    if(keys.has("arrowup")||keys.has("w")) ay -= 1;
    if(keys.has("arrowdown")||keys.has("s")) ay += 1;
    const len = Math.hypot(ax,ay) || 1;
    ax/=len; ay/=len;

    const boost = state.speed>0 ? 1.45 : 1.0;
    player.x += ax * player.speed * boost * dt;
    player.y += ay * player.speed * boost * dt;

    player.x = clamp(player.x, player.r+6, world.w-player.r-6);
    player.y = clamp(player.y, player.r+6, world.h-player.r-6);

    for(const b of world.blocks){
      if(rectHitCircle(b, player.x, player.y, player.r)) pushOut(b, player);
    }

    // collect bubbles
    for(let i=bubbles.length-1;i>=0;i--){
      const b = bubbles[i];
      if(Math.hypot(player.x-b.x, player.y-b.y) < player.r + b.r - 4){
        collectBubble(b);
        bubbles.splice(i,1);
      }
    }

    // collect coins
    for(let i=coins.length-1;i>=0;i--){
      const c = coins[i];
      if(Math.hypot(player.x-c.x, player.y-c.y) < player.r + c.r - 2){
        collectCoin();
        coins.splice(i,1);
      }
    }
    // keep coins available
    if(coins.length < 8){
      for(let k=0;k<10;k++){
        const c = makeCoin(); keepOutOfBlocks(c); coins.push(c);
      }
    }

    // enemies (easy: pause often + avoid safe zone)
    for(const e of enemies){
      e.pauseT -= dt;
      let chasing = true;
      if(e.pauseT <= 0){
        // alternate pause/chase
        chasing = false;
        e.pauseT = rnd(0.7, 1.8);
        // 50% chance to resume chase quickly
        if(Math.random() < 0.5) e.pauseT = rnd(0.4, 0.9);
      }

      if(chasing){
        // if player in safe zone, enemies drift away instead of entering
        const target = inside(safeZone, player.x, player.y)
          ? { x: e.x + (e.x < safeZone.x ? -120 : 120), y: e.y + (e.y < safeZone.y ? -120 : 120) }
          : player;

        const dx = target.x - e.x;
        const dy = target.y - e.y;
        const d = Math.hypot(dx,dy) || 1;
        e.x += (dx/d) * e.speed * dt;
        e.y += (dy/d) * e.speed * dt;
      }

      // keep inside bounds
      e.x = clamp(e.x, e.r+6, world.w-e.r-6);
      e.y = clamp(e.y, e.r+6, world.h-e.r-6);

      // collide blocks
      for(const b of world.blocks){
        if(rectHitCircle(b, e.x, e.y, e.r)) pushOut(b, e);
      }

      // hit player (very forgiving)
      const hit = Math.hypot(player.x-e.x, player.y-e.y) < player.r + e.r - 6;
      if(hit && state.hurtCD <= 0){
        if(state.shield > 0){
          beep(520,70);
          showToast("üõ°Ô∏è Shield blocked!");
          state.hurtCD = 1.4;
        }else{
          setHearts(state.hearts - 1);
          beep(180,120);
          showToast("üëæ Ouch! Run to the safe zone!");
          state.hurtCD = 1.8; // longer invincibility
          if(state.hearts <= 0){
            // gentle fail: just retry popup
            state.checking = true;
            $("resultTitle").textContent = "Try Again üôÇ";
            $("resultStars").textContent = "‚≠ê";
            $("resultBody").innerHTML = "Enemies got you. Press Retry and try again!";
            $("nextLevelBtn").textContent = (state.level >= MAX_LEVEL) ? "üéì Get Certificate" : "‚û°Ô∏è Next Level";
            $("resultOverlay").style.display = "flex";
            refreshPause();
          }
        }
      }
    }
  }

  // Drawing
  function roundRect(ctx,x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr);
    ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr);
    ctx.arcTo(x,y,x+w,y,rr);
    ctx.closePath();
  }

  function render(){
    const cw = canvas.clientWidth;
    const ch = canvas.clientHeight;
    ctx.clearRect(0,0,cw,ch);

    // scale world to canvas
    const sx = cw / world.w;
    const sy = ch / world.h;
    ctx.save();
    ctx.scale(sx, sy);

    // background
    const bg = ctx.createLinearGradient(0,0,world.w,world.h);
    bg.addColorStop(0,"rgba(108,99,255,.08)");
    bg.addColorStop(1,"rgba(0,194,255,.08)");
    ctx.fillStyle = bg;
    ctx.fillRect(0,0,world.w,world.h);

    // safe zone
    ctx.fillStyle = "rgba(34,197,94,.10)";
    ctx.strokeStyle = "rgba(34,197,94,.25)";
    ctx.lineWidth = 4;
    roundRect(ctx, safeZone.x, safeZone.y, safeZone.w, safeZone.h, 20);
    ctx.fill(); ctx.stroke();
    ctx.fillStyle = "rgba(31,42,55,.55)";
    ctx.font = "900 16px ui-rounded, system-ui";
    ctx.fillText("üü© SAFE ZONE", safeZone.x + 16, safeZone.y + 30);

    // blocks
    for(const b of world.blocks){
      ctx.fillStyle = "rgba(0,0,0,.10)";
      ctx.fillRect(b.x+6,b.y+6,b.w,b.h);
      ctx.fillStyle = "rgba(255,255,255,.92)";
      ctx.strokeStyle = "rgba(108,99,255,.18)";
      ctx.lineWidth = 4;
      roundRect(ctx, b.x,b.y,b.w,b.h,16);
      ctx.fill(); ctx.stroke();
      ctx.fillStyle = "rgba(31,42,55,.50)";
      ctx.fillText("üìö", b.x+12, b.y+32);
    }

    // coins
    for(const c of coins){
      c.bob += 0.05;
      const by = c.y + Math.sin(c.bob)*2;
      ctx.fillStyle = "rgba(0,0,0,.10)";
      ctx.beginPath(); ctx.arc(c.x+3,by+3,c.r,0,Math.PI*2); ctx.fill();
      const g = ctx.createRadialGradient(c.x-4,by-4,2,c.x,by,c.r+10);
      g.addColorStop(0,"rgba(245,158,11,.85)");
      g.addColorStop(1,"rgba(245,158,11,.18)");
      ctx.fillStyle=g;
      ctx.strokeStyle="rgba(245,158,11,.30)";
      ctx.lineWidth=4;
      ctx.beginPath(); ctx.arc(c.x,by,c.r,0,Math.PI*2); ctx.fill(); ctx.stroke();
      ctx.font="900 14px ui-rounded, system-ui";
      ctx.fillStyle="rgba(31,42,55,.70)";
      ctx.fillText("ü™ô", c.x-7, by+5);
    }

    // bubbles
    ctx.font="1000 14px ui-rounded, system-ui";
    for(const b of bubbles){
      b.bob += 0.03;
      const by = b.y + Math.sin(b.bob)*3;

      ctx.fillStyle="rgba(0,0,0,.10)";
      ctx.beginPath(); ctx.arc(b.x+4,by+4,b.r,0,Math.PI*2); ctx.fill();

      const isBad = !b.good;
      const gr = ctx.createRadialGradient(b.x-10,by-10,6,b.x,by,b.r+12);
      if(isBad){ gr.addColorStop(0,"rgba(239,68,68,.75)"); gr.addColorStop(1,"rgba(239,68,68,.18)"); }
      else{ gr.addColorStop(0,"rgba(0,194,255,.55)"); gr.addColorStop(1,"rgba(108,99,255,.16)"); }
      ctx.fillStyle=gr;
      ctx.strokeStyle=isBad ? "rgba(239,68,68,.35)" : "rgba(108,99,255,.22)";
      ctx.lineWidth=4;
      ctx.beginPath(); ctx.arc(b.x,by,b.r,0,Math.PI*2); ctx.fill(); ctx.stroke();

      const icon = b.type==="Subject"?"üè∑Ô∏è":b.type==="Greeting"?"üëã":b.type==="Sentence"?"üìù":"üôè";
      ctx.fillStyle="rgba(31,42,55,.86)";
      ctx.fillText(icon+" "+b.type, b.x - b.r + 12, by - 6);
    }

    // enemies
    ctx.font="28px ui-rounded, system-ui";
    ctx.textAlign="center"; ctx.textBaseline="middle";
    for(const e of enemies){
      ctx.fillStyle="rgba(0,0,0,.12)";
      ctx.beginPath(); ctx.ellipse(e.x+5,e.y+11,e.r*0.9,e.r*0.55,0,0,Math.PI*2); ctx.fill();

      const eg = ctx.createRadialGradient(e.x-10,e.y-10,6,e.x,e.y,e.r+14);
      eg.addColorStop(0,"rgba(255,255,255,.95)");
      eg.addColorStop(1,"rgba(239,68,68,.18)");
      ctx.fillStyle=eg;
      ctx.strokeStyle="rgba(239,68,68,.25)";
      ctx.lineWidth=4;
      ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2); ctx.fill(); ctx.stroke();
      ctx.fillText("üëæ", e.x, e.y+1);
    }

    // player + shield ring
    if(state.shield > 0){
      ctx.strokeStyle="rgba(0,194,255,.30)";
      ctx.lineWidth=8;
      ctx.beginPath(); ctx.arc(player.x,player.y,player.r+12,0,Math.PI*2); ctx.stroke();
    }

    ctx.fillStyle="rgba(0,0,0,.12)";
    ctx.beginPath(); ctx.ellipse(player.x+6,player.y+11,player.r*0.9,player.r*0.55,0,0,Math.PI*2); ctx.fill();
    const pg = ctx.createRadialGradient(player.x-10,player.y-10,6,player.x,player.y,player.r+14);
    pg.addColorStop(0,"rgba(255,255,255,.95)");
    pg.addColorStop(1,"rgba(108,99,255,.18)");
    ctx.fillStyle=pg;
    ctx.strokeStyle="rgba(108,99,255,.28)";
    ctx.lineWidth=5;
    ctx.beginPath(); ctx.arc(player.x,player.y,player.r,0,Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.fillStyle="rgba(31,42,55,.92)";
    ctx.font="28px ui-rounded, system-ui";
    ctx.fillText(state.shield>0 ? "üòé" : "üôÇ", player.x, player.y+1);

    ctx.restore();
  }

  function loop(t){
    refreshPause();

    const dt = Math.min(0.04, (t - last) / 1000);
    last = t;

    // PAUSE: stop updates while popup open
    if(!state.paused && state.hearts > 0) update(dt);

    render();
    requestAnimationFrame(loop);
  }

  // Buttons / Popups (pause aware)
  $("howBtn").addEventListener("click", ()=>{
    $("howOverlay").style.display="flex";
    refreshPause();
  });
  $("closeHow").addEventListener("click", ()=>{
    $("howOverlay").style.display="none";
    refreshPause();
  });
  $("okHow").addEventListener("click", ()=>{
    $("howOverlay").style.display="none";
    refreshPause();
  });

  $("closeResult").addEventListener("click", ()=>{
    $("resultOverlay").style.display="none";
    refreshPause();
  });
  $("retryBtn").addEventListener("click", retryLevel);
  $("nextLevelBtn").addEventListener("click", goNextLevel);

  $("closeCert").addEventListener("click", ()=>{
    $("certOverlay").style.display="none";
    refreshPause();
  });
  $("savePngCert").addEventListener("click", downloadCertPNG);
  $("restartGame").addEventListener("click", ()=>{
    $("certOverlay").style.display="none";
    refreshPause();

    state.level = 1;
    $("levelUI").textContent = state.level;
    setCoins(0);
    setStars(0);
    retryLevel();
    showToast("üéÆ New game started!");
  });

  $("resetBtn").addEventListener("click", ()=>{
    // close any popups too
    $("howOverlay").style.display="none";
    $("resultOverlay").style.display="none";
    $("certOverlay").style.display="none";
    refreshPause();

    setHearts(3); setStars(0);
    state.shield = 10; state.speed=0; state.hurtCD=0;
    player.x=120; player.y=120;
    resetCollected();
    spawnAll();
    showToast("üîÅ Reset!");
  });

  $("studentName").addEventListener("input", updateRightPanel);

  // Init
  function init(){
    makeBlocks();
    setHearts(3);
    setStars(0);
    setCoins(0);
    $("levelUI").textContent = state.level;
    const L = currentLevel();
    $("goalText").textContent = `Goal: ${L.name} ‚Äî ${L.goal}`;
    resetCollected();
    spawnAll();
    resizeCanvas();
    refreshPause();
    requestAnimationFrame(loop);
  }

  // Resize canvas to fit container
  const ro = new ResizeObserver(()=>{ resizeCanvas(); });
  ro.observe($("game").parentElement);
  window.addEventListener("resize", resizeCanvas);

  init();
})();
</script>
</body>
</html>
